---
title: "Visualiza√ß√£o - Remunera√ß√£o base"
subtitle: "An√°lises sem√¢nticas"
author: "Joellen Silva"
date: "today"
date-format: "D.MMM.YYYY"
date-modified: "last-modified"
lang: pt-BR
format:
  html:
    html-math-method: katex
    css: style.css
    anchor-sections: true
    code-fold: true
    code-tools: true
    code-link: true
    code-line-numbers: true
    code-background: false
    code-summary: "C√≥digo"
    toc: true
    toc-title: "√çndice"
    toc-depth: 4
    toc-float: false
    toc-collapsed: false
    footnotes-hover: true
    smooth-scroll: true
    fig-width: 11
    fig-height: 7
    search: true
    embed-resources: true
    theme:
          light: cosmo
          dark: darkly
knitr:
  opts_chunk:
    echo: true
    collapse: true
    message: false
    warning: false
    comment: "#>"
editor_options:
  chunk_output_type: console
execute:
  cache: false
---

```{r}
#| label: libs-and-sources
library(tidyverse)
library(here)
library(gt)
library(ggiraph)
library(glue)
library(scales)
library(plotly)
library(dplyr)
library(zoo)
library(ggplot2)
options(scipen = 999)

source(here("tasks/view-remuneracao-base/src/00-plot-aesthetics.R"), encoding = "utf-8")
```

## Resumo

Este relat√≥rio tem como objetivo analisar a soma das remunera√ß√µes mensais de todos os membros por √≥rg√£o, considerando apenas a remunera√ß√£o b√°sica, excluindo benef√≠cios.

Principais resultados:

- Tend√™ncias na Remunera√ß√£o
  - Identifica√ß√£o de flutua√ß√µes na remunera√ß√£o mensal por √≥rg√£o.
- Compara√ß√£o com M√©dias M√≥veis
  - Meses em que a remunera√ß√£o superou a m√©dia m√≥vel dos √∫ltimos tr√™s anos para o mesmo m√™s.
  - Meses em que a remunera√ß√£o ultrapassou a m√©dia m√≥vel dos √∫ltimos tr√™s meses.

## Metodologia

Para cada m√™s, o somat√≥rio da remunera√ß√£o base ser√° comparada com duas m√©dias m√≥veis:

- A m√©dia m√≥vel dos √∫ltimos tr√™s anos para o mesmo m√™s.
- A m√©dia m√≥vel dos √∫ltimos tr√™s meses em rela√ß√£o ao m√™s atual.

Al√©m da visualiza√ß√£o gr√°fica, ser√° apresentada uma tabela destacando os meses em que a soma das remunera√ß√µes ultrapassou uma das m√©dias comparativas, especificando qual delas foi superada.

## An√°lise

:::{.callout-tip}
### Extra√ß√£o dos dados
Os dados foram agrupados utilizando a query: `./tasks/view-remuneracao-base/src/01-extracao.sql`
:::

```{r}
#| label: print-dataset

data <- readRDS(here(glue("tasks/view-remuneracao-base/outputs/extracao-{today()}.rds")))


df <- data %>%
  arrange(ano, mes) %>%
  filter(id_orgao == "cnj") %>%
  mutate(ano_mes = sprintf("%d/%02d", ano, mes)) %>%
  mutate(media_movel_3_meses = lag(rollapply(valor, width = 3, FUN = mean, fill = NA, align = "right"))) %>%
  group_by(mes) %>%
  mutate(media_movel_3_anos = lag(rollapply(valor, width = 3, FUN = mean, fill = NA, align = "right"))) %>%
  ungroup()

```

### Visualiza√ß√£o M√©dias M√≥veis

Apresenta-se a an√°lise das m√©dias m√≥veis da remunera√ß√£o mensal, considerando duas abordagens:

- M√©dia m√≥vel dos √∫ltimos 3 meses para cada m√™s
- M√©dia do mesmo m√™s nos √∫ltimos 3 anos

Para ilustrar essas compara√ß√µes, foram geradas duas op√ß√µes de visualiza√ß√£o:

- Op√ß√£o 1: Dois gr√°ficos separados, cada um representando uma das m√©dias m√≥veis individualmente.
- Op√ß√£o 2: Um √∫nico gr√°fico combinando ambas as m√©dias para facilitar a an√°lise conjunta.

Qual abordagem adotar?

#### @fig-barras-mm3m

:::{.callout-tip}
üìä Gr√°fico interativo, use o mouse para ver detalhes dos dados.
:::

A seguir, apresentamos a visualiza√ß√£o dos somat√≥rios da remunera√ß√£o base por m√™s e ano, acompanhada da m√©dia m√≥vel dos √∫ltimos tr√™s meses em rela√ß√£o ao m√™s atual. Essa an√°lise permite identificar varia√ß√µes sazonais e tend√™ncias ao longo do per√≠odo analisado.

::: {.callout-note}
### Legenda:
- üî¥ **M√©dia M√≥vel 3 Meses**: Representa a m√©dia dos 3 meses anteriores.
:::
```{r}
#| label: fig-barras-mm3m
#| fig-cap: "Gr√°fico Remunera√ß√£o Base - M√©dia M√≥vel 3 Meses"
grafico_mm3m <- ggplot(df, aes(x = ano_mes, y = valor, text = paste0("Ano/M√™s: ", ano_mes, "<br>Valor: R$ ", scales::comma(valor, accuracy = 0.1), "<br>M√©dia 3 meses: R$ ", scales::comma(media_movel_3_meses, accuracy = 0.1)))) +
  geom_bar(stat = "identity", fill = "steelblue") +
  geom_errorbar(aes(ymin = media_movel_3_meses, ymax = media_movel_3_meses),
    width = 2.5, color = "red", linewidth = 1.2, na.rm = TRUE
  ) +
  labs(title = "Somat√≥rio Remunera√ß√£o Base - M√©dia M√≥vel 3 Meses", x = "Ano/M√™s", y = "Valor") +
  theme_minimal()

grafico_interativo_mm3m <- ggplotly(grafico_mm3m, tooltip = "text")

grafico_interativo_mm3m %>%
  layout(
    xaxis = list(
      tickmode = "array",
      tickvals = df$ano_mes,
      ticktext = df$ano_mes,
      rangeslider = list(visible = TRUE),
      range = c(length(df$ano_mes) - 11.5, length(df$ano_mes) + 0.5),
      tickangle = 90
    ),
    yaxis = list(
      tickformat = ",.0f",
      showgrid = TRUE
    ),
    dragmode = "pan",
    autosize = TRUE
  )
```

#### @fig-barras-mm3a

:::{.callout-tip}
üìä Gr√°fico interativo, use o mouse para ver detalhes dos dados.
:::

A seguir, apresentamos a visualiza√ß√£o dos somat√≥rios da remunera√ß√£o base por m√™s e ano, juntamente com a m√©dia m√≥vel dos √∫ltimos tr√™s anos para o mesmo m√™s. Essa an√°lise permite avaliar a varia√ß√£o das remunera√ß√µes ao longo do tempo e identificar poss√≠veis tend√™ncias ou anomalias.

::: {.callout-note}
### Legenda:
- üî¥ **M√©dia M√≥vel 3 Anos**: Representa a m√©dia do mesmo m√™s nos 3 anos anteriores.
:::

```{r}
#| label: fig-barras-mm3a
#| fig-cap: "Gr√°fico Remunera√ß√£o Base - M√©dia M√≥vel 3 Anos/M√™s"
grafico_mm3a <- ggplot(df, aes(x = ano_mes, y = valor, text = paste0("Ano/M√™s: ", ano_mes, "<br>Valor: R$ ", scales::comma(valor, accuracy = 0.1), "<br>M√©dia 3 anos: R$ ", scales::comma(media_movel_3_anos, accuracy = 0.1)))) +
  geom_bar(stat = "identity", fill = "steelblue") +
  geom_errorbar(aes(ymin = media_movel_3_anos, ymax = media_movel_3_anos),
    width = 2.5, color = "red", linewidth = 1.2, na.rm = TRUE
  ) +
  labs(
    title = "Somat√≥rio Remunera√ß√£o Base - M√©dia M√≥vel 3 Anos",
    x = "Ano/M√™s", y = "Valor"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, size = 10))

grafico_interativo_mm3a <- ggplotly(grafico_mm3a, tooltip = "text")

grafico_interativo_mm3a %>%
  layout(
    xaxis = list(
      tickmode = "array",
      tickvals = df$ano_mes,
      ticktext = df$ano_mes,
      rangeslider = list(visible = TRUE),
      range = c(length(df$ano_mes) - 11.5, length(df$ano_mes) + 0.5),
      tickangle = 90
    ),
    yaxis = list(
      tickformat = ",",
      showgrid = TRUE
    ),
    dragmode = "pan",
    autosize = TRUE
  )
```

#### @fig-barras-mm

:::{.callout-tip}
üìä Gr√°fico interativo, use o mouse para ver detalhes dos dados.
:::

A seguir, apresentamos a visualiza√ß√£o dos somat√≥rios da remunera√ß√£o base por m√™s e ano, acompanhados de duas m√©dias m√≥veis:

- M√©dia m√≥vel dos √∫ltimos tr√™s meses em rela√ß√£o ao m√™s atual
- M√©dia m√≥vel dos √∫ltimos tr√™s anos para o mesmo m√™s

::: {.callout-note}
### Legenda:
- üü¢ **M√©dia M√≥vel 3 Anos**: Representa a m√©dia do mesmo m√™s nos 3 anos anteriores.
- üî¥ **M√©dia M√≥vel 3 Meses**: Representa a m√©dia dos 3 meses anteriores.
:::

```{r}
#| label: fig-barras-mm
#| fig-cap: "Gr√°fico Remunera√ß√£o Base - M√©dias M√≥veis 3 Anos e 3 Meses"
grafico_mm <- ggplot(df, aes(x = ano_mes, y = valor, text = paste0("Ano/M√™s: ", ano_mes, "<br>Valor: R$ ", scales::comma(valor, accuracy = 0.1), "<br>M√©dia 3 meses: R$ ", scales::comma(media_movel_3_meses, accuracy = 0.1), "<br>M√©dia 3 anos: R$ ", scales::comma(media_movel_3_anos, accuracy = 0.1)))) +
  geom_bar(stat = "identity", fill = "steelblue") +
  geom_errorbar(aes(ymin = media_movel_3_anos, ymax = media_movel_3_anos, color = "M√©dia M√≥vel 3 Anos", text = paste0("<br>M√©dia 3 anos: R$ ", scales::comma(media_movel_3_anos, accuracy = 0.1))),
    width = 2.5, color = "green", linewidth = 1.2, na.rm = TRUE
  ) +
  geom_errorbar(aes(ymin = media_movel_3_meses, ymax = media_movel_3_meses, color = "M√©dia M√≥vel 3 Meses", , text = paste0("<br>M√©dia 3 meses: R$ ", scales::comma(media_movel_3_meses, accuracy = 0.1))),
    width = 2.5, color = "red", linewidth = 1.2, na.rm = TRUE
  ) +
  scale_color_manual(values = c("M√©dia M√≥vel 3 Anos" = "green", "M√©dia M√≥vel 3 Meses" = "red")) +
  labs(
    title = "Somat√≥rio Remunera√ß√£o Base - M√©dia M√≥vel 3 Anos e 3 Meses",
    x = "Ano/M√™s", y = "Valor", color = "Legenda"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, size = 10))

grafico_interativo_mm <- ggplotly(grafico_mm, tooltip = "text")

grafico_interativo_mm %>%
  layout(
    xaxis = list(
      tickmode = "array",
      tickvals = df$ano_mes,
      ticktext = df$ano_mes,
      rangeslider = list(visible = TRUE),
      range = c(length(df$ano_mes) - 11.5, length(df$ano_mes) + 0.5),
      tickangle = 90
    ),
    yaxis = list(
      tickformat = ",.0f",
      showgrid = TRUE
    ),
    dragmode = "pan",
    autosize = TRUE
  )
```

#### @tbl-meses-que-ultrapassaram-mm

A tabela abaixo apresenta um resumo dos meses dentro do per√≠odo analisado em que a soma da remunera√ß√£o base ultrapassou pelo menos uma das m√©dias m√≥veis. Para cada ocorr√™ncia, √© indicado qual das m√©dias foi superada.
```{r}
#| label: tbl-meses-que-ultrapassaram-mm
#| tbl-cap: "Meses que Ultrapassaram M√©dias M√≥veis"
tabela <- df %>%
  filter(!is.na(media_movel_3_meses), !is.na(media_movel_3_anos)) %>%
  filter(valor > media_movel_3_meses | valor > media_movel_3_anos) %>%
  mutate(
    maior_que = case_when(
      valor > media_movel_3_meses & valor < media_movel_3_anos ~ "media_movel_3_meses",
      valor > media_movel_3_anos & valor < media_movel_3_meses ~ "media_movel_3_anos",
      valor > media_movel_3_meses & valor > media_movel_3_anos ~ "ambas"
    )
  )

tabela %>%
  summarise(
    ano = ano,
    mes = mes,
    somatoria = valor,
    maior_que = maior_que
  ) %>%
  arrange(-ano) %>%
  gt(groupname_col = "") %>%
  fmt_currency_brl(columns = somatoria) %>%
  tab_style(
    style = cell_text(size = pct(65)),
    locations = cells_body(columns = maior_que)
  ) %>%
  tab_style(
    style = cell_text(size = pct(75)),
    locations = cells_body(columns = maior_que)
  ) %>%
  tab_options(table.width = pct(100)) %>%
  opt_interactive(use_search = TRUE, use_highlight = TRUE)
```

<!--  -->
